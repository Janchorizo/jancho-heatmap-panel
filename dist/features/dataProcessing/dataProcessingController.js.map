{"version":3,"sources":["../../../src/features/dataProcessing/dataProcessingController.ts"],"names":["MetricsPanelCtrl","TimeSeries","_","dataProcessingDefaults","dataProcessingEditor","Feature","$scope","panelController","ctrl","panel","defaults","cloneDeep","events","on","onInitEditMode","bind","onDataReceived","onRefresh","addEditorTab","dataList","length","rawData","data","map","seriesHandler","mapSeriesToValue","render","series","datapoints","alias","target","timeseries","value","id","dataProcessing","valueStat","Math","min","s","max","reduce","a","b","c","abs"],"mappings":"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","file":"dataProcessingController.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport _ from 'lodash';\n\nimport { dataProcessingDefaults } from \"./dataProcessingDefaults.js\";\nimport { dataProcessingEditor } from \"./dataProcessingEditor.js\";\n\n/**\n * @alias dataProcessingFeature\n * @classdesc <h2>dataProcessing feature</h2>\n * Implementación de una funcionalidad\n * Mediante el patrón mediador, se suscribe a los eventos del plugin a través\n * de la referencia al $scope que se le pasa.\n * <br>\n * <br><h3>Funcionalidad</h3>\n * Trata todos los datos provenientes de series temporales, los pasa a una estructura manejable\n * y aplica la estadística elegida.<br>\n * <br><h3>Eventos suscritos</h3>\n * <ul>\n *  <li>init-edit-mode</li>\n *  <li>data-received</li>\n *  <li>refresh</li>\n * </ul>\n */\nexport default class Feature{\n  /**\n   * constructor - description\n   *\n   * @param  {type} $scope Es el contexto del plugin que se pasa para poder suscribirse\n   * a los eventos.\n   * @return {type}        Nueva instancia de un Feature\n   */\n  constructor( $scope){\n      this.$scope = $scope;\n      this.panelController = $scope.ctrl;\n      this.panel = this.panelController.panel;\n      \n      const defaults = _.cloneDeep(dataProcessingDefaults);\n      _.defaults( this.panelController.panel, defaults);\n\n      this.panelController.events.on( 'init-edit-mode', this.onInitEditMode.bind(this));\n      this.panelController.events.on( 'data-received', this.onDataReceived.bind(this));\n      //this.panelController.events.on( 'panel-initialized', this.onPanelInitialized);\n      this.panelController.events.on( 'refresh', this.onRefresh.bind(this));\n  }\n\n  /**\n   * onInitEditMode - Handler para el evento de init-edit-mode\n   *\n   * @memberof dataProcessingFeature\n   */\n  onInitEditMode(){\n      this.panelController.addEditorTab( 'DataProcessing', dataProcessingEditor( this.$scope), 2);\n  }\n\n  /**\n   * onDataReceived - description\n   *\n   * @param  {type} dataList description\n   * @memberof dataProcessingFeature\n   */\n  onDataReceived( dataList){\n    if( dataList.length > 0){\n      this.panel.rawData = dataList;\n      let data = dataList.map( this.seriesHandler.bind( this));\n      this.panel.data = [];\n      this.panel.data = data.map( this.mapSeriesToValue.bind( this));\n    }else{ return;}\n    this.panelController.render();\n  }\n\n  /**\n   * onRefresh - description\n   *\n   * @memberof dataProcessingFeature\n   */\n  onRefresh(){\n    if( this.panel.rawData.length > 0){\n      let data = this.panel.rawData.map( this.seriesHandler.bind( this));\n      this.panel.data = data.map( this.mapSeriesToValue.bind( this));\n    }else{ return;}\n    this.panelController.render();\n  }\n\n  /**\n   * seriesHandler - Extrae una estrctura más simple del dataList que proporciona Grafana.\n   *\n   * @param  {type} dataList Estructura original que proporciona Grafana\n   * @return {TimeSeries}          Estructura simplificada para las métricas suministradas\n   * @memberof dataProcessingFeature\n   */\n  seriesHandler( dataList){\n      //tratar nulos\n      let series = new TimeSeries({\n          datapoints: dataList.datapoints,\n          alias: dataList.target\n      });\n      return( series);\n  }\n\n  /**\n   * mapSeriesToValue - Transforma una serie temporal a un objeto\n   * con el alias de la métrica, y el valor asociado (según la estadística elegida).\n   *\n   * @param  {Timeseries} timeseries receives a timeseries object containing all values registered for\n   * a metric.\n   * @return {Object}            Object containing both the alias, and the value for a metric\n   * @memberof dataProcessingFeature\n   */\n  mapSeriesToValue( timeseries){\n        let value = {};\n        value['metric'] = timeseries.id;\n        switch( this.panel.dataProcessing.valueStat){\n            case 'min':\n                value['value'] = Math.min( ...timeseries.datapoints.map(function(s){ return( s[0]);}));\n            break;\n            case 'max':\n                value['value'] = Math.max( ...timeseries.datapoints.map(function(s){ return( s[0]);}));\n            break;\n            case 'avg':\n                value['value'] = timeseries.datapoints.map(function(s){ return( s[0]);})\n                                            .reduce( (a,b)=>a+b, 0) / timeseries.datapoints.length\n            break;\n            case 'current':\n                value['value'] = timeseries.datapoints[ timeseries.datapoints.length -1][0];\n            break;\n            case 'total':\n                value['value'] = timeseries.datapoints.map(function(s){ return( s[0]);}).reduce( (a,b)=>a+b, 0);\n            break;\n            case 'first':\n                value['value'] = timeseries.datapoints[0][0];\n            break;\n            case 'diff':\n                value['value'] =\n                _.max(\n                  _.map(\n                  _.map( timeseries.datapoints.map( (a)=>{return a[0];}), (a,b,c)=>{\n                              if(b< c.length -1){ return [a, c[b+1]];\n                              }else{return[0,0];}}),\n                        (a)=>{return Math.abs(a[0]-a[1]);}));\n            break;\n            case 'range':\n                value['value'] = _.max( timeseries.datapoints.map((a)=>{return a[0];})) - _.min( timeseries.datapoints.map((a)=>{return a[0];}));\n            break;\n            case 'last_time':\n                value['value'] = timeseries.datapoints[ timeseries.datapoints.length -1][1];\n            break;\n        }\n        return( value);\n    }\n}\n"]}