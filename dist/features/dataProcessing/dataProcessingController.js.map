{"version":3,"sources":["../../../src/features/dataProcessing/dataProcessingController.ts"],"names":["MetricsPanelCtrl","TimeSeries","_","dataProcessingDefaults","dataProcessingEditor","Feature","$scope","panelController","ctrl","panel","defaults","cloneDeep","events","on","onInitEditMode","bind","onDataReceived","onRefresh","addEditorTab","dataList","length","rawData","data","map","seriesHandler","mapSeriesToValue","render","series","datapoints","alias","target","timeseries","value","id","elements","s","dataProcessing","valueStat","Math","min","max","reduce","a","b","pairs","c","differences","abs"],"mappings":"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","file":"dataProcessingController.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport _ from 'lodash';\n\nimport { dataProcessingDefaults } from \"./dataProcessingDefaults.js\";\nimport { dataProcessingEditor } from \"./dataProcessingEditor.js\";\n\n/**\n * @alias dataProcessingFeature\n * @classdesc <h2>dataProcessing feature</h2>\n * Implementación de una funcionalidad\n * Mediante el patrón mediador, se suscribe a los eventos del plugin a través\n * de la referencia al $scope que se le pasa.\n * <br>\n * <br><h3>Funcionalidad</h3>\n * Trata todos los datos provenientes de series temporales, los pasa a una estructura manejable\n * y aplica la estadística elegida.<br>\n * <br><h3>Eventos suscritos</h3>\n * <ul>\n *  <li>init-edit-mode</li>\n *  <li>data-received</li>\n *  <li>refresh</li>\n * </ul>\n */\nexport default class Feature{\n  /**\n   * constructor - description\n   *\n   * @param  {type} $scope Es el contexto del plugin que se pasa para poder suscribirse\n   * a los eventos.\n   * @return {type}        Nueva instancia de un Feature\n   */\n  constructor( $scope){\n      this.$scope = $scope;\n      this.panelController = $scope.ctrl;\n      this.panel = this.panelController.panel;\n\n      const defaults = _.cloneDeep(dataProcessingDefaults);\n      _.defaults( this.panelController.panel, defaults);\n\n      this.panelController.events.on( 'init-edit-mode', this.onInitEditMode.bind(this));\n      this.panelController.events.on( 'data-received', this.onDataReceived.bind(this));\n      //this.panelController.events.on( 'panel-initialized', this.onPanelInitialized);\n      this.panelController.events.on( 'refresh', this.onRefresh.bind(this));\n  }\n\n  /**\n   * onInitEditMode - Handler para el evento de init-edit-mode\n   *\n   * @memberof dataProcessingFeature\n   */\n  onInitEditMode(){\n      this.panelController.addEditorTab( 'DataProcessing', dataProcessingEditor( this.$scope), 2);\n  }\n\n  /**\n   * onDataReceived - description\n   *\n   * @param  {type} dataList description\n   * @memberof dataProcessingFeature\n   */\n  onDataReceived( dataList){\n    if( dataList.length > 0){\n      this.panel.rawData = dataList;\n      let data = dataList.map( this.seriesHandler.bind( this));\n      this.panel.data = [];\n      this.panel.data = data.map( this.mapSeriesToValue.bind( this));\n    }else{ return;}\n    this.panelController.render();\n  }\n\n  /**\n   * onRefresh - description\n   *\n   * @memberof dataProcessingFeature\n   */\n  onRefresh(){\n    if( this.panel.rawData.length > 0){\n      let data = this.panel.rawData.map( this.seriesHandler.bind( this));\n      this.panel.data = data.map( this.mapSeriesToValue.bind( this));\n    }else{ return;}\n    this.panelController.render();\n  }\n\n  /**\n   * seriesHandler - Extrae una estrctura más simple del dataList que proporciona Grafana.\n   *\n   * @param  {type} dataList Estructura original que proporciona Grafana\n   * @return {TimeSeries}          Estructura simplificada para las métricas suministradas\n   * @memberof dataProcessingFeature\n   */\n  seriesHandler( dataList){\n      //tratar nulos\n      let series = new TimeSeries({\n          datapoints: dataList.datapoints,\n          alias: dataList.target\n      });\n      return( series);\n  }\n\n  /**\n   * mapSeriesToValue - Transforma una serie temporal a un objeto\n   * con el alias de la métrica, y el valor asociado (según la estadística elegida).\n   *\n   * @param  {Timeseries} timeseries receives a timeseries object containing all values registered for\n   * a metric.\n   * @return {Object}            Object containing both the alias, and the value for a metric\n   * @memberof dataProcessingFeature\n   */\n  mapSeriesToValue( timeseries){\n        let value = {};\n        value['metric'] = timeseries.id;\n        const elements = timeseries.datapoints.map(function(s){ return( s[0]);});\n\n        switch( this.panel.dataProcessing.valueStat){\n            case 'min':\n                value['value'] = Math.min( ...elements);\n            break;\n            case 'max':\n                value['value'] = Math.max( ...elements);\n            break;\n            case 'avg':\n                value['value'] = elements.reduce( (a,b)=>a+b, 0) / timeseries.datapoints.length\n            break;\n            case 'current':\n                value['value'] = elements[ timeseries.datapoints.length -1];\n            break;\n            case 'total':;\n                value['value'] = elements.reduce( (a,b)=>a+b, 0);\n            break;\n            case 'first':\n                value['value'] = elements[0];\n            break;\n            case 'diff':\n                const pairs = _.map( elements, (a,b,c)=>{ return (b< c.length -1)?([a, c[b+1]]):([0,0]); });\n                const differences = _.map( pairs, (a)=>{return Math.abs(a[0]-a[1]);});\n                value['value'] =_.max( differences);\n            break;\n            case 'range':\n                value['value'] = _.max(elements) - _.min(elements);\n            break;\n            case 'last_time':\n                value['value'] = timeseries.datapoints[ timeseries.datapoints.length -1][1];\n            break;\n        }\n        return( value);\n    }\n}\n"]}