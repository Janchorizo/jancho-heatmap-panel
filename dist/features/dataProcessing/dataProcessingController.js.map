{"version":3,"sources":["../../../src/features/dataProcessing/dataProcessingController.ts"],"names":["MetricsPanelCtrl","TimeSeries","_","dataProcessingDefaults","dataProcessingEditor","Feature","$scope","panelController","ctrl","panel","defaults","events","on","onInitEditMode","bind","onDataReceived","onRefresh","addEditorTab","dataList","length","rawData","dataProcessing","processingOnGoing","data","map","seriesHandler","mapSeriesToValue","series","datapoints","alias","target","timeseries","value","id","valueStat","Math","min","s","max","reduce","a","b","c","abs"],"mappings":"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","file":"dataProcessingController.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport _ from 'lodash';\n\nimport { dataProcessingDefaults } from \"./dataProcessingDefaults.js\";\nimport { dataProcessingEditor } from \"./dataProcessingEditor.js\";\n\nexport default class Feature{\n  constructor( $scope){\n      this.$scope = $scope;\n      this.panelController = $scope.ctrl;\n      this.panel = this.panelController.panel;\n      _.defaults( this.panelController.panel, dataProcessingDefaults);\n\n      this.panelController.events.on( 'init-edit-mode', this.onInitEditMode.bind(this));\n      this.panelController.events.on( 'data-received', this.onDataReceived.bind(this));\n      //this.panelController.events.on( 'panel-initialized', this.onPanelInitialized);\n      this.panelController.events.on( 'refresh', this.onRefresh.bind(this));\n\n  }\n\n  onInitEditMode(){\n      this.panelController.addEditorTab( 'DataProcessing', dataProcessingEditor( this.$scope), 2);\n  }\n\n  onDataReceived( dataList){\n    if( dataList.length > 0){\n      this.panel.rawData = dataList;\n      this.panel.dataProcessing.processingOnGoing = true;\n\n      let data = dataList.map( this.seriesHandler.bind( this));\n      this.panel.data = data.map( this.mapSeriesToValue.bind( this));\n\n      this.panel.dataProcessing.processingOnGoing = false;\n    }else{ return;}\n  }\n\n  onRefresh(){\n    if( this.panel.rawData.length > 0){\n      this.panel.dataProcessing.processingOnGoing = true;\n\n      let data = this.panel.rawData.map( this.seriesHandler.bind( this));\n      this.panel.data = data.map( this.mapSeriesToValue.bind( this));\n\n      this.panel.dataProcessing.processingOnGoing = false;\n    }else{ return;}\n  }\n\n  seriesHandler( dataList){\n      //tratar nulos\n      let series = new TimeSeries({\n          datapoints: dataList.datapoints,\n          alias: dataList.target\n      });\n      return( series);\n  }\n\n  mapSeriesToValue( timeseries){\n        let value = {};\n        value['metric'] = timeseries.id;\n        switch( this.panel.dataProcessing.valueStat){\n            case 'min':\n                value['value'] = Math.min( ...timeseries.datapoints.map(function(s){ return( s[0]);}));\n            break;\n            case 'max':\n                value['value'] = Math.max( ...timeseries.datapoints.map(function(s){ return( s[0]);}));\n            break;\n            case 'avg':\n                value['value'] = timeseries.datapoints.map(function(s){ return( s[0]);})\n                                            .reduce( (a,b)=>a+b, 0) / timeseries.datapoints.length\n            break;\n            case 'current':\n                value['value'] = timeseries.datapoints[ timeseries.datapoints.length -1][0];\n            break;\n            case 'total':\n                value['value'] = timeseries.datapoints.map(function(s){ return( s[0]);}).reduce( (a,b)=>a+b, 0);\n            break;\n            case 'first':\n                value['value'] = timeseries.datapoints[0][0];\n            break;\n            case 'diff':\n                value['value'] =\n                _.max(\n                  _.map(\n                  _.map( timeseries.datapoints.map( (a)=>{return a[0];}), (a,b,c)=>{\n                              if(b< c.length -1){ return [a, c[b+1]];\n                              }else{return[0,0];}}),\n                        (a)=>{return Math.abs(a[0]-a[1]);}));\n            break;\n            case 'range':\n                value['value'] = _.max( timeseries.datapoints.map((a)=>{return a[0];})) - _.min( timeseries.datapoints.map((a)=>{return a[0];}));\n            break;\n            case 'last_time':\n                value['value'] = timeseries.datapoints[ timeseries.datapoints.length -1][1];\n            break;\n        }\n        return( value);\n    }\n}\n"]}